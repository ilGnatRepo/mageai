(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3277],{14875:function(e,n,r){"use strict";r.d(n,{Z3:function(){return t},ms:function(){return u},s7:function(){return o}});var t=[{autoComplete:"username",label:"Username",required:!0,uuid:"username"},{autoComplete:"email",disabled:!1,label:"Email",required:!0,type:"email",uuid:"email"}],o="password_current",u=[{autoComplete:"current-password",label:"Current password",type:"password",uuid:o},{autoComplete:"new-password",label:"New password",type:"password",uuid:"password"},{autoComplete:"new-password",label:"Confirm new password",type:"password",uuid:"password_confirmation"}]},36043:function(e,n,r){"use strict";var t=r(82394),o=r(21831),u=r(75582),s=r(21764),i=r(82684),l=r(83455),a=r(71180),c=r(31882),d=r(55485),p=r(85854),f=r(44085),m=r(38276),w=r(30160),v=r(17488),b=r(35686),h=r(50018),Z=r(98464),j=r(82359),y=r(14875),_=r(86735),g=r(42122),O=r(72619),x=r(28598);function P(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function C(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?P(Object(r),!0).forEach((function(n){(0,t.Z)(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):P(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}n.Z=function(e){var n=e.disabledFields,r=e.hideFields,P=e.newUser,k=e.onDeleteSuccess,S=e.onSaveSuccess,E=e.showDelete,T=e.title,D=e.user,I=(0,i.useState)(!0),N=I[0],M=I[1],A=(0,i.useState)({}),U=A[0],q=A[1],F=(0,i.useState)(null),L=F[0],R=F[1],G=((0,h.Z)()||{}).owner,B=b.ZP.statuses.list().data,H=(0,i.useMemo)((function(){var e;return(null==B||null===(e=B.statuses)||void 0===e?void 0:e[0])||{}}),[B]),W=H.project_type,X=H.project_uuid,Q="global",z=null,J=null;W===j.k.SUB?(Q="project",z=X):W===j.k.MAIN&&(J="The roles selected here will apply to this user globally.\n                If a user has both a global role and a workspace role,\n                then the role with higher access will take precedence.");var K=b.ZP.roles.list({entity:Q,entity_ids:z?[z]:[],limit_roles:!!P},{revalidateOnFocus:!1}),V=K.data,Y=(K.mutate,(0,i.useMemo)((function(){return(null==V?void 0:V.roles)||[]}),[null==V?void 0:V.roles])),$=(0,l.Db)(P?b.ZP.users.useCreate():b.ZP.users.useUpdate(null==D?void 0:D.id),{onSuccess:function(e){return(0,O.wD)(e,{callback:function(e){var n=e.user,r=y.Z3.concat(y.ms).map((function(e){return e.uuid}));r.push("id");var t=(0,g.GL)(n,r);R(t),s.Am.success(P?"新用户创建成功。":"用户资料更新成功。",{position:s.Am.POSITION.BOTTOM_RIGHT,toastId:"user-update-success-".concat(n.id)}),null==S||S(t)},onErrorCallback:function(e){var n=e.error,r=n.errors,t=n.exception,o=n.message,u=n.type;s.Am.error((null==r?void 0:r.error)||t||o,{position:s.Am.POSITION.BOTTOM_RIGHT,toastId:u})}})}}),ee=(0,u.Z)($,2),ne=ee[0],re=ee[1].isLoading,te=(0,l.Db)(b.ZP.users.useDelete(null==D?void 0:D.id),{onSuccess:function(e){return(0,O.wD)(e,{callback:function(){null==k||k()},onErrorCallback:function(e){var n=e.error,r=n.errors,t=n.message;alert(t),console.log(r)}})}}),oe=(0,u.Z)(te,2),ue=oe[0],se=oe[1].isLoading,ie=r?(0,o.Z)(r):[];P&&ie.push(y.s7);var le=!ie||!ie.includes(y.s7),ae=(0,Z.Z)(D);(0,i.useEffect)((function(){if(D&&(!L||(null==ae?void 0:ae.id)!==(null==D?void 0:D.id))){var e=y.Z3.concat(y.ms).map((function(e){return e.uuid}));R((0,g.GL)(D,e))}null!=L&&L.password||null!=L&&L.password_confirmation?(null==L?void 0:L.password)!==(null==L?void 0:L.password_confirmation)?q({password_confirmation:"密码确认不匹配。"}):!le||null!=L&&L.password_current?q(null):q({password_current:"此字段为必填项。"}):null!=L&&L.password_current&&le?null!=L&&L.password&&null!=L&&L.password_confirmation?q(null):q({password:"此字段为必填项。",password_confirmation:"此字段为必填项。"}):null!=L&&L.password_current||null!=L&&L.password||null!=L&&L.password_confirmation||q(null)}),[L,le,D,ae]);var ce=(0,i.useState)(!1),de=ce[0],pe=ce[1],fe=(0,i.useMemo)((function(){return(de?null==L?void 0:L.roles_new:null==D?void 0:D.roles_new)||[]}),[L,de,D]),me=(0,i.useMemo)((function(){var e=(null==Y?void 0:Y.map((function(e){return e.id})))||[];return null==fe?void 0:fe.filter((function(n){var r=n.id;return e.includes(r)}))}),[fe,Y]);return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(p.Z,{children:T||"编辑资料"}),(0,x.jsxs)("form",{children:[y.Z3.filter((function(e){var n=e.uuid;return!ie||!ie.includes(n)})).map((function(e){var n=e.autoComplete,r=e.disabled,o=e.label,u=e.required,s=e.type,i=e.uuid;return(0,x.jsx)(m.Z,{mt:2,children:(0,x.jsx)(v.Z,{autoComplete:n,disabled:r&&!P,label:o,onChange:function(e){M(!1),R((function(n){return C(C({},n),{},(0,t.Z)({},i,e.target.value))}))},primary:!0,required:u,setContentOnMount:!0,type:s,value:(null==L?void 0:L[i])||""})},i)})),!(null!=D&&D.owner)&&!(null!=ie&&ie.includes("roles"))&&(0,x.jsxs)(m.Z,{mt:2,children:[J&&(0,x.jsx)(m.Z,{mb:1,children:(0,x.jsx)(w.ZP,{children:J})}),(0,x.jsx)(f.Z,{disabled:null==n?void 0:n.includes("roles"),label:"角色",onChange:function(e){var n=(0,_.sE)(Y,(function(n){return n.id==e.target.value}));n&&(M(!1),pe(!0),R((function(e){var r={};return(0,_.sE)(fe,(function(e){return e.id==(null==n?void 0:n.id)}))||(r={roles_new:[].concat((0,o.Z)(fe),[n])}),C(C({},e),r)})))},primary:!0,setContentOnMount:!0,children:Y.map((function(e){var n=e.id,r=e.name;return(0,x.jsx)("option",{value:n,children:r},r)}))}),(0,x.jsx)(m.Z,{mb:1}),(0,x.jsx)(d.ZP,{alignItems:"center",flexWrap:"wrap",children:null==me?void 0:me.map((function(e){var r=e.id,t=e.name;return(0,x.jsx)(m.Z,{mb:1,mr:1,children:(0,x.jsx)(c.Z,{disabled:null==n?void 0:n.includes("roles"),label:t,onClick:function(){M(!1),pe(!0),R((function(e){return C(C({},e),{},{roles_new:(0,_.Od)(fe,(function(e){return e.id===r}))})}))},primary:!0})},"user_roles/".concat(t))}))})]}),(0,x.jsxs)(m.Z,{mt:5,children:[(0,x.jsx)(p.Z,{children:P?"密码":"更改密码"}),y.ms.filter((function(e){var n=e.uuid;return!ie||!ie.includes(n)})).map((function(e){var n=e.autoComplete,r=e.disabled,o=e.label,u=e.required,s=e.type,i=e.uuid;return(0,x.jsx)(m.Z,{mt:2,children:(0,x.jsx)(v.Z,{autoComplete:n,disabled:r,label:o,meta:{error:null==U?void 0:U[i],touched:!(null==U||!U[i])},onChange:function(e){M(!1),R((function(n){return C(C({},n),{},(0,t.Z)({},i,e.target.value))}))},primary:!0,required:u,setContentOnMount:!0,type:s,value:(null==L?void 0:L[i])||""})},i)}))]}),(0,x.jsx)(m.Z,{mt:5,children:(0,x.jsxs)(d.ZP,{children:[(0,x.jsx)(a.ZP,{disabled:N||U&&!(0,g.Qr)(U),loading:re,onClick:function(){var e,n=C({},L);"roles_new"in n&&(n.roles_new=null===(e=L.roles_new)||void 0===e?void 0:e.map((function(e){return e.id})));ne({user:n})},primary:!0,children:P?"创建新用户":"更新用户资料"}),E&&G&&(0,x.jsx)(m.Z,{ml:1,children:(0,x.jsx)(a.ZP,{danger:!0,loading:se,onClick:function(){window.confirm("Are you sure you want to delete ".concat(L.username||L.email,"?"))&&ue()},children:"删除用户"})})]})})]})]})}},37560:function(e,n,r){"use strict";r.r(n);var t=r(77837),o=r(38860),u=r.n(o),s=(r(82684),r(34376)),i=r(93808),l=r(38276),a=r(36043),c=r(59533),d=r(70515),p=r(75083),f=r(28598);function m(){var e=(0,s.useRouter)();return(0,f.jsx)(c.Z,{breadcrumbs:[{label:function(){return"Workspaces"},linkProps:{as:"/manage",href:"/manage"}},{label:function(){return"Users"},linkProps:{as:"/manage/users",href:"/manage/users"}},{bold:!0,label:function(){return"New"}}],pageName:p.L6.USERS,children:(0,f.jsx)(l.Z,{p:d.cd,children:(0,f.jsx)(a.Z,{hideFields:["roles"],newUser:!0,onSaveSuccess:function(n){e.push("/manage/users/[user]","/manage/users/".concat(null==n?void 0:n.id))},title:"Add new user",user:{}})})})}m.getInitialProps=function(){var e=(0,t.Z)(u().mark((function e(n){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{});case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),n.default=(0,i.Z)(m)},94e3:function(e,n,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/manage/users/new",function(){return r(37560)}])},80022:function(e,n,r){"use strict";function t(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}r.d(n,{Z:function(){return t}})},15544:function(e,n,r){"use strict";function t(e){return t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(e)}r.d(n,{Z:function(){return t}})},13692:function(e,n,r){"use strict";r.d(n,{Z:function(){return o}});var t=r(61049);function o(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&(0,t.Z)(e,n)}},93189:function(e,n,r){"use strict";r.d(n,{Z:function(){return u}});var t=r(12539),o=r(80022);function u(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return(0,o.Z)(e)}}},function(e){e.O(0,[449,1598,9774,2888,179],(function(){return n=94e3,e(e.s=n);var n}));var n=e.O();_N_E=n}]);